# stock-analysis

# 场景说明

假设我现在要看某个股票，例如股票代码为300350。我要用近两年的股票时序数据作为样本数据，提取其特征因子，并筛选出关键特征因子。然后基于样本数据训练一个股票价格预测模型，并用来预测未来的股价。

这里我选的时序数据为2023年7月到2025年5月20日，然后拿这些时序数据利用 tsfresh 来提取特征因子并识别出最重要的特征因子。再把样本数据以 8:2 切分为训练集和测试集。基于随机森林回归算法来训练出股票价格预测模型。然后用 2025年5月20日 到 2025年6月10日 来进行股价预测。因为这20天也已经过去了，所以股票价格都有，因此可以用来从统计学维度衡量股票价格预测模型的好坏。

量化交易分析和时间序列建模，很重要的一点就是对于时序数据的特征因子自动提取。手动设计特征并不是一个好的方式，因为：
1. 容易遗漏重要信息
2. 耗时
3. 人为假设特征因子

因此采用 tsfresh 的开源 python 工具来自动化特征提取和筛选。它的作用是从原始的时间序列中自动生成上千个统计特征，并结合目标变量来做显著性筛选。

---

# Demo步骤说明

## [步骤一] 数据准备

- 造数，生成300350这2年来的股票数据作为时序数据，截止日期设置为2025年5月20日。
- `start_date` = 当前日期减去2年，`end_date` = 2025-05-20，采样频率为“天”（daily）。
- 采样内容包括：日期、开盘价、收盘价、最高价、最低价、成交量等基础指标。
- 技术指标采用 talib 中定义的技术指标，如 talib.RSI、talib.MACD、talib.STOCH 等。

### 技术指标说明（部分）

| 技术指标名 | 指标含义 |
| :--- | :--- |
| RSI | 相对强弱指标，用来衡量价格变动速度和变化的指标。取值在0到100之间，默认周期为14天。RSI>70表示超买，RSI<30表示超卖，50为多空平衡。 |
| MACD | 移动平均收敛/发散指标。用于显示价格的趋势和动能。MACD线=12日EMA-26日EMA，信号线=MACD的9日EMA，柱状图=MACD线-信号线。 |
| KDJ | 随机指标，由K线（快线）、D线（慢线）、J线组成。K线、D线>80为超买，<20为超卖，K线上穿D线为买入信号，下穿为卖出信号。 |
| ... | ... |

- 最终生成一个csv文件，基于日期获得基础指标和技术指标，并保存到 `01data.csv` 中。

---

## [步骤二] 利用 tsfresh 进行特征提取

- 利用 tsfresh 提取特征。基于收盘价、成交量、RSI、MACD 等字段，构建滑动窗口，基于20天（`WINDOW_SIZE=20`）为一个周期的滑动窗口，提取时间序列特征。
- tsfresh 输入数据格式为 Pandas DataFrame，需包含3列：`id`（标识不同时间序列）、`time`（时间戳）、`value`（观测值）。
- 特征提取通过 `extract_features` 方法完成，`impute(features)` 用于填充缺失值。

---

## [步骤三] 特征选择

- 因子太多，需将无用因子筛选掉。采用基于IC值的稳定性筛因子。
- 使用 tsfresh 的 `select_features()` 方法，利用目标变量对提取的特征进行统计筛选，确保与预测任务最相关的特征。
- 最终从数千个特征因子中筛选出有用的104个因子。

---

## [步骤四] 绘制基于时间的股价和主要特征因子趋势图

- 绘制基于时间的股价和主要特征因子趋势图，利用 `draw_graph.py` 进行绘制。

---

## [步骤五] 分析某个特征因子（如 macd）

- 可用程序分析特定特征因子。在上述特征因子趋势图中，最亮眼的是绿色部分，即特征1452=macd_friedrich_coefficients。
- 重点分析该特征因子。

---

## [步骤六] 基于随机森林训练股票价格预测模型

- 将采样数据一部分作为训练集，一部分作为测试集，基于随机森林训练股票价格预测模型。
- 使用随机森林回归模型，核心类为 `RandomForestRegressor`。

---

## [步骤七] 基于预测股价模型预测股价并评估模型效果

- 检验效果，基于股价预测模型预测股价，并与真实股价比较来评估模型效果。
- 用2023年7月到2025年5月20日的数据训练模型，预测2025年5月20日到2025年6月10日的股价。
- 由于这段时间已过去，真实股价可查，用预测价格曲线与真实价格曲线的数理统计指标，来表征模型效果。
